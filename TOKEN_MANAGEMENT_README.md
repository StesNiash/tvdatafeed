# Система управления токенами TvDatafeed

## Обзор

Реализована система автоматического сохранения и загрузки auth token для библиотеки TvDatafeed, которая решает проблему частых запросов капчи при многократном использовании библиотеки.

## Проблема

При каждом запуске файла, использующего библиотеку TvDatafeed, происходил запрос нового auth token к TradingView. При 5+ запросах в течение дня TradingView требовал прохождение капчи, что нарушало полностью автоматический сбор данных.

## Решение

Создана система сохранения токенов между сессиями с следующими возможностями:

### Основные функции

1. **Автоматическое сохранение токенов** - токен сохраняется в JSON файл после успешной аутентификации
2. **Автоматическая загрузка токенов** - при инициализации сначала проверяется наличие сохраненного токена
3. **Проверка валидности токенов** - перед использованием токен проверяется на актуальность
4. **Безопасность** - токены привязаны к конкретному пользователю
5. **Управление токенами** - возможность принудительного обновления и удаления токенов

### Новые файлы

- `tvDatafeed/token_manager.py` - класс TokenManager для управления токенами
- `test_token_management.py` - полный тест функционала
- `simple_test.py` - упрощенный тест без зависимостей

### Изменения в существующих файлах

- `tvDatafeed/main.py` - добавлена интеграция с TokenManager
- `tvDatafeed/__init__.py` - экспорт TokenManager
- `requirements.txt` - добавлены selenium и beautifulsoup4

## Использование

### Базовое использование

```python
from tvDatafeed import TvDatafeed

# Создание с автоматическим сохранением токена
tv = TvDatafeed(username='your_username', password='your_password')

# При повторном создании токен будет загружен из файла
# Это избежит необходимости повторной аутентификации и капчи
tv2 = TvDatafeed(username='your_username', password='your_password')
```

### Управление токенами

```python
# Получение информации о токене
token_info = tv.get_token_info()
if token_info:
    print(f'Токен создан: {token_info["created_at"]}')
    print(f'Возраст токена: {token_info["age_days"]} дней')

# Принудительное обновление токена
if tv.refresh_token():
    print('Токен успешно обновлен')

# Удаление сохраненного токена
tv.delete_saved_token()
```

### Пользовательский файл токена

```python
# Использование пользовательского файла для токена
tv = TvDatafeed(
    username='your_username',
    password='your_password',
    token_file='my_custom_token.json'
)
```

### Прямое использование TokenManager

```python
from tvDatafeed import TokenManager

# Создание менеджера токенов
token_manager = TokenManager("my_token.json")

# Сохранение токена
token_manager.save_token("auth_token_123", "username")

# Загрузка токена
token = token_manager.load_token("username")

# Получение информации о токене
info = token_manager.get_token_info()

# Проверка истечения токена
is_expired = token_manager.is_token_expired(max_age_days=30)

# Удаление токена
token_manager.delete_token()
```

## Новые параметры конструктора TvDatafeed

- `token_file` (str, optional) - путь к файлу для сохранения токена. По умолчанию: "tvdatafeed_token.json"

## Новые методы TvDatafeed

- `get_token_info()` - получить информацию о текущем токене
- `refresh_token()` - принудительно обновить токен
- `delete_saved_token()` - удалить сохраненный токен

## Преимущества

✅ **Автоматическое сохранение и загрузка токенов**
✅ **Избежание частых запросов капчи**
✅ **Полностью автоматический сбор данных**
✅ **Проверка валидности токенов**
✅ **Безопасное хранение с привязкой к пользователю**
✅ **Обратная совместимость** - существующий код продолжает работать без изменений
✅ **Гибкая настройка** - возможность использования пользовательских файлов токенов

## Структура файла токена

```json
{
  "token": "auth_token_string",
  "username": "user_name",
  "created_at": "2025-01-08T09:48:00.000000",
  "last_used": "2025-01-08T09:48:00.000000"
}
```

## Безопасность

- Токены сохраняются локально в JSON файлах
- Каждый токен привязан к конкретному пользователю
- Автоматическая проверка валидности токенов
- Возможность установки максимального возраста токена

## Тестирование

Запустите тесты для проверки функционала:

```bash
# Полный тест (требует все зависимости)
python test_token_management.py

# Упрощенный тест (только TokenManager)
python simple_test.py
```

## Установка зависимостей

```bash
pip install -r requirements.txt
```

## Совместимость

- Полностью обратно совместимо с существующим кодом
- Работает с TvDatafeed и TvDatafeedLive
- Поддерживает все существующие функции библиотеки
